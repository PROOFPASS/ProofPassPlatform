# Environment Configuration Guide

ProofPass Platform uses multiple `.env` files for different deployment scenarios. This guide explains each file and when to use it.

## Configuration Files Overview

| File | Purpose | Used By | Priority |
|------|---------|---------|----------|
| `.env.example` | Template with all variables | Developers (copy to `.env`) | Reference only |
| `.env` | Local development | Developer machine | High |
| `.env.docker` | Docker Compose | Docker containers | High (in container) |
| `.env.production` | Production deployment | Production servers | High (in prod) |
| `apps/api/.env` | API-specific overrides | API service | Medium |
| `apps/platform/.env` | Platform-specific overrides | Platform service | Medium |

## Quick Start

### For New Developers

```bash
# 1. Copy the template
cp .env.example .env

# 2. Generate Stellar keys at: https://laboratory.stellar.org/#account-creator?network=test

# 3. Update the .env file with your keys:
# STELLAR_SECRET_KEY=S...
# STELLAR_PUBLIC_KEY=G...

# 4. Start development
docker-compose up
```

## File Descriptions

### 1. `.env.example` (Template)

**Purpose**: Template file showing all required environment variables with example values.

**Location**: Repository root
**Committed to Git**: ✅ Yes
**When to use**: As reference when creating new `.env` files

**Key Variables**:
```bash
# Application
NODE_ENV=development
PORT=3000
LOG_LEVEL=info
CORS_ORIGIN=*

# Database
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=proofpass
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres

# Redis
REDIS_URL=redis://localhost:6379

# Stellar Blockchain
STELLAR_NETWORK=testnet
STELLAR_SECRET_KEY=S...    # Your secret key
STELLAR_PUBLIC_KEY=G...    # Your public key

# Authentication
JWT_SECRET=change-this-secret-in-production
JWT_EXPIRES_IN=7d
API_KEY_SALT=change-this-salt-in-production
```

**Notes**:
- Optimism blockchain integration is NOT IMPLEMENTED YET (marked in file)
- Stellar keys must be generated at https://laboratory.stellar.org

---

### 2. `.env` (Local Development)

**Purpose**: Your personal development configuration.

**Location**: Repository root
**Committed to Git**: ❌ No (in `.gitignore`)
**When to use**: Always when developing locally

**How to create**:
```bash
cp .env.example .env
# Edit with your actual values
```

**Important**:
- Never commit this file (contains secrets)
- Generate your own Stellar testnet account
- Use strong JWT secrets for local testing
- Set `NODE_ENV=development` for debug output

---

### 3. `.env.docker` (Docker Compose)

**Purpose**: Configuration for Docker Compose deployments.

**Location**: Repository root
**Committed to Git**: ⚠️  Depends (usually no)
**When to use**: When running `docker-compose up`

**Key Differences from `.env`**:
- Database host: `postgres` (service name) instead of `localhost`
- Redis URL: `redis://redis:6379` (service name)
- Uses internal Docker networking

**Example**:
```bash
NODE_ENV=production
PORT=3000

# Docker service names
DATABASE_HOST=postgres
DATABASE_PORT=5432
DATABASE_NAME=proofpass
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres

REDIS_URL=redis://redis:6379

# Your blockchain keys
STELLAR_NETWORK=testnet
STELLAR_SECRET_KEY=S...
STELLAR_PUBLIC_KEY=G...

JWT_SECRET=change-in-production
```

**How Docker Compose uses it**:
```yaml
# docker-compose.yml
services:
  api:
    env_file:
      - .env.docker  # <-- Loaded here
    environment:
      - NODE_ENV=production
```

---

### 4. `.env.production` (Production Deployment)

**Purpose**: Production environment configuration.

**Location**: Repository root
**Committed to Git**: ❌ No
**When to use**: Production servers only

**Critical Security**:
- Strong JWT secrets (use `openssl rand -hex 32`)
- Production database credentials
- Mainnet Stellar account (NOT testnet)
- Restricted CORS origins
- Error logging enabled

**Example**:
```bash
NODE_ENV=production
PORT=3000
LOG_LEVEL=error
CORS_ORIGIN=https://proofpass.co

# Production database (managed service recommended)
DATABASE_HOST=prod-db.amazonaws.com
DATABASE_PORT=5432
DATABASE_NAME=proofpass_prod
DATABASE_USER=proofpass_user
DATABASE_PASSWORD=<STRONG_PASSWORD>

# Production Redis
REDIS_URL=redis://prod-redis.amazonaws.com:6379

# MAINNET Stellar (NOT testnet!)
STELLAR_NETWORK=mainnet
STELLAR_SECRET_KEY=<MAINNET_SECRET>
STELLAR_PUBLIC_KEY=<MAINNET_PUBLIC>

# Strong secrets (64+ characters)
JWT_SECRET=<GENERATED_SECRET>
API_KEY_SALT=<GENERATED_SALT>
```

**Production Checklist**:
- [ ] Strong, unique JWT_SECRET (64+ characters)
- [ ] Strong, unique API_KEY_SALT (64+ characters)
- [ ] Database password rotated regularly
- [ ] Stellar mainnet account funded
- [ ] CORS restricted to your domain
- [ ] LOG_LEVEL=error or warn
- [ ] Backups configured
- [ ] Monitoring enabled

---

### 5. `apps/api/.env` (API Service Override)

**Purpose**: API-specific configuration that overrides root `.env`.

**Location**: `apps/api/`
**Committed to Git**: ❌ No
**When to use**: When API needs different config than platform

**Use Cases**:
- Different database connection for API only
- API-specific feature flags
- Custom logging for API service

**Example**:
```bash
# API-specific overrides
PORT=4000
LOG_LEVEL=debug
DATABASE_NAME=proofpass_api_dev
```

**Loading Priority**:
1. `apps/api/.env` (highest)
2. Root `.env`
3. `.env.example` (reference only)

---

### 6. `apps/platform/.env` (Platform Service Override)

**Purpose**: Platform-specific configuration.

**Location**: `apps/platform/`
**Committed to Git**: ❌ No
**When to use**: When platform needs different config

**Example**:
```bash
# Platform-specific overrides
PORT=3000
PUBLIC_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:4000
```

---

## Environment Variables Reference

### Application Settings

| Variable | Description | Example | Required |
|----------|-------------|---------|----------|
| `NODE_ENV` | Environment mode | `development`, `production` | ✅ |
| `PORT` | Service port | `3000` | ✅ |
| `LOG_LEVEL` | Logging verbosity | `debug`, `info`, `warn`, `error` | ✅ |
| `CORS_ORIGIN` | Allowed origins | `*` (dev), `https://proofpass.co` (prod) | ✅ |

### Database (PostgreSQL)

| Variable | Description | Example | Required |
|----------|-------------|---------|----------|
| `DATABASE_HOST` | Database host | `localhost`, `postgres` (Docker) | ✅ |
| `DATABASE_PORT` | Database port | `5432` | ✅ |
| `DATABASE_NAME` | Database name | `proofpass` | ✅ |
| `DATABASE_USER` | Database user | `postgres` | ✅ |
| `DATABASE_PASSWORD` | Database password | `postgres` | ✅ |

### Cache (Redis)

| Variable | Description | Example | Required |
|----------|-------------|---------|----------|
| `REDIS_URL` | Redis connection URL | `redis://localhost:6379` | ✅ |

### Blockchain (Stellar)

| Variable | Description | Example | Required |
|----------|-------------|---------|----------|
| `STELLAR_NETWORK` | Network | `testnet`, `mainnet` | ✅ |
| `STELLAR_SECRET_KEY` | Account secret key | `S...` | ✅ |
| `STELLAR_PUBLIC_KEY` | Account public key | `G...` | ✅ |

**Generate Stellar Keys**:
- Testnet: https://laboratory.stellar.org/#account-creator?network=test
- Mainnet: Use a secure hardware wallet

### Authentication & Security

| Variable | Description | Example | Required |
|----------|-------------|---------|----------|
| `JWT_SECRET` | JWT signing secret | Random 64+ char string | ✅ |
| `JWT_EXPIRES_IN` | JWT expiration | `7d`, `24h` | ✅ |
| `API_KEY_SALT` | API key hashing salt | Random 64+ char string | ✅ |

**Generate Secrets**:
```bash
# Generate a secure 64-character secret
openssl rand -hex 32
```

---

## Best Practices

### Security

1. **Never commit `.env` files** (except `.env.example`)
2. **Use strong secrets** (64+ characters) in production
3. **Rotate credentials** regularly (every 90 days)
4. **Use environment-specific accounts** (separate testnet/mainnet)
5. **Restrict CORS** in production
6. **Use managed databases** in production (not self-hosted)

### Development

1. **Always copy from `.env.example`** when setting up
2. **Document new variables** in `.env.example`
3. **Use `.env.docker`** for Docker development
4. **Keep secrets out of logs**
5. **Use `.env.local`** for temporary overrides

### Production

1. **Use secret management** (AWS Secrets Manager, HashiCorp Vault)
2. **Enable monitoring** and alerting
3. **Set up backups** for databases
4. **Use strong passwords** (20+ characters)
5. **Enable SSL/TLS** for all connections
6. **Review access logs** regularly

---

## Troubleshooting

### Issue: Environment variables not loading

**Solution**:
```bash
# 1. Check file exists
ls -la .env

# 2. Check file format (no BOM, LF line endings)
file .env

# 3. Check for syntax errors
cat .env | grep -v '^#' | grep -v '^$'
```

### Issue: Docker can't connect to database

**Solution**: Use service names, not `localhost`
```bash
# ❌ Wrong
DATABASE_HOST=localhost

# ✅ Correct
DATABASE_HOST=postgres
```

### Issue: Stellar keys not working

**Solution**:
1. Verify keys at https://laboratory.stellar.org/#account-viewer
2. Ensure network matches (testnet vs mainnet)
3. Check account is funded (testnet: use friendbot)

### Issue: JWT authentication failing

**Solution**:
```bash
# Generate new secret
openssl rand -hex 32

# Update .env
JWT_SECRET=<new_secret>

# Restart service
docker-compose restart api
```

---

## Migration Guide

### From Environment Variables to `.env` File

If you're currently using inline environment variables:

```bash
# Old way (inline)
DATABASE_HOST=localhost DATABASE_PORT=5432 npm start

# New way (.env file)
echo "DATABASE_HOST=localhost" >> .env
echo "DATABASE_PORT=5432" >> .env
npm start
```

### From `.env` to Docker `.env.docker`

```bash
# 1. Copy your .env
cp .env .env.docker

# 2. Update service names
sed -i 's/localhost/postgres/g' .env.docker
sed -i 's/redis:\/\/localhost/redis:\/\/redis/g' .env.docker

# 3. Test
docker-compose up
```

---

## Environment-Specific Tips

### Development

```bash
NODE_ENV=development
LOG_LEVEL=debug
STELLAR_NETWORK=testnet
CORS_ORIGIN=*
```

### Staging

```bash
NODE_ENV=staging
LOG_LEVEL=info
STELLAR_NETWORK=testnet
CORS_ORIGIN=https://staging.proofpass.co
```

### Production

```bash
NODE_ENV=production
LOG_LEVEL=error
STELLAR_NETWORK=mainnet
CORS_ORIGIN=https://proofpass.co
```

---

## Additional Resources

- [Twelve-Factor App - Config](https://12factor.net/config)
- [Stellar Documentation](https://developers.stellar.org/)
- [PostgreSQL Environment Variables](https://www.postgresql.org/docs/current/libpq-envars.html)
- [Redis Configuration](https://redis.io/docs/management/config/)

---

## Support

**Questions?** See [main documentation](./README.md) or [deployment guide](./docs/deployment.md)

**Found a bug?** [Open an issue](https://github.com/PROOFPASS/ProofPassPlatform/issues)
